<div data-controller="variants">
  <h3><%= link_to "Back", products_path %></h3>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
    <!-- Image Gallery -->
    <div>
      <% if @product.has_variants? %>
        <!-- Product images (shared across all variants) -->
        <% if @product.images.attached? %>
          <div id="variant-image-gallery">
            <%= image_tag @product.images.first.variant(resize_to_limit: [1200, 1200]), style: "width: 100%; border-radius: 8px; margin-bottom: 10px;" %>
          </div>
          <% if @product.images.count > 1 %>
            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
              <% @product.images.each do |image| %>
                <% large_variant_url = url_for(image.variant(resize_to_limit: [1200, 1200])) %>
                <%= image_tag image.variant(resize_to_limit: [200, 200]),
                    style: "width: 80px; height: 80px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s;",
                    onclick: "document.getElementById('variant-image-gallery').innerHTML = '<img src=\"#{large_variant_url}\" style=\"width: 100%; border-radius: 8px;\">'" %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <div style="width: 100%; height: 400px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">
            No image available
          </div>
        <% end %>
      <% else %>
        <!-- Simple product images -->
        <% if @product.images.attached? %>
          <div id="simple-image-main">
            <%= image_tag @product.images.first.variant(resize_to_limit: [1200, 1200]), style: "width: 100%; border-radius: 8px; margin-bottom: 10px;" %>
          </div>
          <% if @product.images.count > 1 %>
            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
              <% @product.images.each do |image| %>
                <% large_variant_url = url_for(image.variant(resize_to_limit: [1200, 1200])) %>
                <%= image_tag image.variant(resize_to_limit: [200, 200]),
                    style: "width: 80px; height: 80px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s;",
                    onclick: "document.getElementById('simple-image-main').innerHTML = '<img src=\"#{large_variant_url}\" style=\"width: 100%; border-radius: 8px;\">'" %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <div style="width: 100%; height: 400px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #999;">
            No image available
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Product Details -->
    <div>
      <h1><%= @product.name %></h1>
      <p><%= @product.description %></p>

      <% if @product.variants.any? %>
        <!-- Pass variant data -->
        <div data-variants-target="variants"
             data-variants="<%= @product.variants.map { |v|
               {
                 id: v.id,
                 size: v.size,
                 grind: v.grind,
                 price: v.price,
                 inventory_quantity: v.inventory_quantity,
                 sku: v.sku
               }
             }.to_json %>">
          <div>
            <label for="size"><strong>Size</strong></label>
            <select id="size" data-action="change->variants#updateSize" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Select Size</option>
              <% @product.variants.map(&:size).compact.uniq.each do |size| %>
                <option value="<%= size %>"><%= size.humanize %></option>
              <% end %>
            </select>
          </div>

          <div style="margin-top: 15px;">
            <label for="grind"><strong>Grind</strong></label>
            <select id="grind" data-action="change->variants#updatePrice" disabled style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">Select Grind</option>
            </select>
          </div>
        </div>

        <div style="margin-top: 20px;">
          <p><strong>Price:</strong> <span data-variants-target="price" style="font-size: 1.5em; color: #28a745; font-weight: bold;">--</span></p>

          <!-- SKU display -->
          <p><strong>SKU:</strong> <span data-variants-target="sku">--</span></p>

          <!-- Stock status display -->
          <div data-variants-target="stockStatus">
            <p><strong>Stock:</strong> <span data-variants-target="stockText">--</span></p>
          </div>
        </div>

        <%= form_with url: cart_items_path, class: "add-to-cart-form" do |form| %>
          <%= form.hidden_field :variant_id, data: { "variants-target": "variantId" } %>
          <%= form.number_field :quantity, value: 1, min: 1, max: 999, data: { "variants-target": "quantity" },
              style: "width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;" %>
          <%= form.submit "Add to cart", data: { "variants-target": "submitButton" },
              disabled: true,
              style: "padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;" %>
        <% end %>
      <% else %>
        <!-- Simple product details -->
        <div style="margin-top: 20px;">
          <p><strong>Price:</strong> <span style="font-size: 1.5em; color: #28a745; font-weight: bold;"><%= number_to_currency(@product.price) %></span></p>

          <!-- SKU display -->
          <p><strong>SKU:</strong> <%= @product.sku || "Not assigned" %></p>

          <!-- Stock status for simple product -->
          <% if @product.out_of_stock? %>
            <p><strong style="color: red; font-size: 1.1em;">Out of Stock</strong></p>
          <% elsif @product.inventory_quantity < 10 %>
            <p><strong style="color: orange;">Low Stock - Only <%= @product.inventory_quantity %> left</strong></p>
          <% else %>
            <p><strong style="color: green;">In Stock (<%= @product.inventory_quantity %> available)</strong></p>
          <% end %>
        </div>

        <%= form_with url: cart_items_path do |form| %>
          <%= form.hidden_field :product_id, value: @product.id %>
          <%= form.number_field :quantity, value: 1, min: 1, max: @product.inventory_quantity,
              style: "width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;" %>
          <% submit_style = @product.out_of_stock? ?
              "padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: not-allowed;" :
              "padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;" %>
          <%= form.submit "Add to cart",
              disabled: @product.out_of_stock?,
              style: submit_style %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Admin actions -->
  <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; display: flex; gap: 20px;">
    <%= link_to "Edit", edit_product_path(@product),
        style: "padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; font-weight: 500;" %>
    <%= link_to "Delete", product_path(@product),
        data: {
          "turbo-method": :delete,
          "turbo-confirm": "Are you sure you want to delete this product?"
        },
        style: "padding: 10px 20px; background: #dc3545; color: white; text-decoration: none; border-radius: 4px; font-weight: 500;" %>
  </div>
</div>

